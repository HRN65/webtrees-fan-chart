<?php
declare(strict_types=1);

/**
 * See LICENSE.md file for further details.
 */

use Fisharebest\Webtrees\I18N;
use Fisharebest\Webtrees\Individual;
use Fisharebest\Webtrees\View;
use MagicSunday\Webtrees\FanChart\Config;

/** @var Config     $config */
/** @var string     $title */
/** @var string     $moduleName */
/** @var Individual $individual */
/** @var array      $chartParams */
?>

<div id="page-fan">
    <h2 class="wt-page-title"><?= $title ?></h2>

    <form class="wt-page-options wt-page-options-fan-chart d-print-none">
        <input type="hidden" name="route" value="module">
        <input type="hidden" name="module" value="<?= e($moduleName) ?>">
        <input type="hidden" name="ged" value="<?= e($tree->name()) ?>">
        <input type="hidden" name="action" value="Chart">

        <div class="form-group row">
            <label class="col-sm-3 col-form-label wt-page-options-label" for="xref">
                <?= I18N::translate('Individual') ?>
            </label>
            <div class="col-sm-9 wt-page-options-value">
                <?= view('components/select-individual', [
                        'name'       => 'xref',
                        'individual' => $individual,
                        'tree'       => $tree,
                    ]);
                ?>
            </div>
        </div>

        <div class="form-group row">
            <label class="col-sm-3 col-form-label wt-page-options-label" for="fanDegree">
                <?= I18N::translate('Layout'); ?>
            </label>
            <div class="col-sm-9 wt-page-options-value">
                <?= view('components/select', [
                        'name'     => 'fanDegree',
                        'selected' => $config->getFanDegree(),
                        'options'  => $config->getFanDegreeList(),
                        'class'    => 'form-control-sm',
                    ]);
                ?>
            </div>
        </div>

        <div class="form-group row">
            <label class="col-sm-3 col-form-label wt-page-options-label" for="generations">
                <?= I18N::translate('Generations'); ?>
            </label>
            <div class="col-sm-9 wt-page-options-value">
                <?= view('components/select', [
                        'name'     => 'generations',
                        'selected' => $config->getGenerations(),
                        'options'  => $config->getGenerationsList(),
                        'class'    => 'form-control-sm',
                    ]);
                ?>
            </div>
        </div>

        <div id="moreField" style="display: <?= ($config->getShowMore() ? 'block' : 'none') ?>">
            <div class="form-group row">
                <label class="col-form-label col-sm-3 wt-page-options-label">
                    <?= I18N::translate('Presentation'); ?>
                </label>
                <div class="col-sm-9 wt-page-options-value">
                    <?= view('components/checkbox', [
                            'label'   => I18N::translate('Hide empty segments'),
                            'name'    => 'hideEmptySegments',
                            'checked' => $config->getHideEmptySegments(),
                        ]);
                    ?>

                    <?= view('components/checkbox', [
                            'label'   => I18N::translate('Show color gradients'),
                            'name'    => 'showColorGradients',
                            'checked' => $config->getShowColorGradients(),
                        ]);
                    ?>
                </div>
            </div>

            <div class="form-group row">
                <label class="col-sm-3 col-form-label wt-page-options-label" for="innerArcs">
                    <?= I18N::translate('Number of inner circles'); ?>
                </label>
                <div class="col-sm-9 wt-page-options-value">
                    <?= view('components/select', [
                            'name'     => 'innerArcs',
                            'selected' => $config->getInnerArcs(),
                            'options'  => $config->getInnerArcsList(),
                            'class'    => 'form-control-sm',
                        ]);
                    ?>
                    <small class="form-text text-muted">
                        <?= I18N::translate('Specifies the number of circles in which the text is written along a arc.'); ?>
                    </small>
                </div>
            </div>

            <div class="form-group row">
                <label class="col-sm-3 col-form-label wt-page-options-label" for="fontScale">
                    <?= I18N::translate('Font size'); ?>
                </label>
                <div class="col-sm-9 wt-page-options-value">
                    <div class="input-group input-group-sm">
                        <input class="form-control" type="text" name="fontScale" id="fontScale"
                               maxlength="3" placeholder="100" value="<?= $config->getFontScale(); ?>">
                        <div class="input-group-append">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group row">
            <div class="col-sm-12 wt-page-options-value text-center">
                <div class="btn-group-toggle btn-group-sm float-left more" data-toggle="buttons">
                    <label class="btn btn-primary<?= ($config->getShowMore() ? ' active' : '') ?>" id="more">
                        <input type="checkbox" name="showMore" value="1"<?= ($config->getShowMore() ? ' checked' : '') ?>>
                        <?= I18N::translate('More options ...') ?>
                    </label>
                </div>

                <div class="btn-group-sm">
                    <input class="btn btn-primary" type="submit" value="<?= I18N::translate('view') ?>">
                    <input class="btn btn-primary" type="reset" value="<?= I18N::translate('reset') ?>" id="resetButton">
                </div>
            </div>
        </div>
    </form>

    <div class="row">
        <div id="fan_chart" class="wt-ajax-load wt-page-content wt-chart wt-fan-chart"></div>
    </div>
</div>

<?php View::push('styles') ?>
<link rel="stylesheet" type="text/css" href="modules_v4/webtrees-fan-chart/resources/css/fan-chart.css">
<?php View::endpush(); ?>

<?php View::push('javascript'); ?>
<script type="text/javascript" src="modules_v4/webtrees-fan-chart/resources/js/fan-chart.min.js"></script>
<script type="text/javascript">

$("#more").click(function (event) {
    event.preventDefault();
    $("#moreField").toggle();
});

function AncestralFanChart(data)
{
    let options = new rso.Options(
        data.individualUrl,
        data.updateUrl,
        data.labels,
        data.generations,
        data.fanDegree,
        data.defaultColor,
        data.fontScale,
        data.fontColor,
        data.hideEmptySegments,
        data.showColorGradients,
        data.rtl,
        data.innerArcs
    );

    options = Object.assign({}, options, data);

    new rso.Chart("#fan_chart", options);
}

new AncestralFanChart(<?= $chartParams ?>);

document.getElementById("fan_chart")
    .scrollIntoView(true);

</script>
<?php View::endpush(); ?>
